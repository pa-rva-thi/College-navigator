<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CampusNav â€” Smart Indoor Navigation</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f0ede8;--surface:#fff;--ink:#1a1714;--muted:#8a8480;
  --accent:#2563eb;--accent2:#f97316;--border:#dedad4;
  --shadow:0 4px 24px rgba(26,23,20,.12);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;display:flex;flex-direction:column}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar{background:var(--surface);border-bottom:1.5px solid var(--border);padding:9px 16px;display:flex;align-items:center;gap:9px;position:sticky;top:0;z-index:100;flex-wrap:wrap}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1.1rem;color:var(--accent);letter-spacing:-.5px;white-space:nowrap;margin-right:4px}
.logo span{color:var(--accent2)}
.search-wrap{position:relative;flex:1;min-width:140px;max-width:280px;display:flex;align-items:center}
#searchInput{width:100%;padding:8px 12px 8px 34px;border:1.5px solid var(--border);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:.83rem;background:var(--bg);color:var(--ink);outline:none;transition:border .2s}
#searchInput:focus{border-color:var(--accent);background:#fff}
.search-icon{position:absolute;left:10px;color:var(--muted);font-size:.9rem;pointer-events:none}
#autocomplete{position:absolute;top:calc(100% + 5px);left:0;width:210px;background:var(--surface);border:1.5px solid var(--border);border-radius:10px;box-shadow:var(--shadow);z-index:200;overflow:hidden;display:none}
#autocomplete.visible{display:block}
.suggest-item{padding:8px 12px;font-size:.8rem;cursor:pointer;display:flex;align-items:center;gap:7px;border-bottom:1px solid var(--border);transition:background .15s}
.suggest-item:last-child{border-bottom:none}
.suggest-item:hover{background:#eff6ff;color:var(--accent)}
.suggest-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
select{padding:7px 9px;border:1.5px solid var(--border);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:.79rem;background:var(--bg);color:var(--ink);outline:none;cursor:pointer}
select:focus{border-color:var(--accent)}
.btn{padding:7px 13px;border:none;border-radius:10px;font-family:'Syne',sans-serif;font-weight:600;font-size:.78rem;cursor:pointer;white-space:nowrap;transition:opacity .2s}
.btn:hover{opacity:.82}
.btn-route{background:var(--accent);color:#fff}
.btn-clear{background:#e11d48;color:#fff}
.btn-signin{background:var(--ink);color:#fff;margin-left:auto}

/* â”€â”€ MAIN â”€â”€ */
.main{flex:1;display:grid;grid-template-columns:70% 30%;min-height:0;height:calc(100vh - 55px)}
.map-area{position:relative;background:#c8e6c9;overflow:hidden;border-right:1.5px solid var(--border);cursor:grab}
.map-area:active{cursor:grabbing}
#campusCanvas{position:absolute;top:0;left:0}
.zoom-controls{position:absolute;bottom:16px;right:16px;display:flex;flex-direction:column;gap:5px;z-index:10}
.zoom-btn{width:33px;height:33px;background:var(--surface);border:1.5px solid var(--border);border-radius:8px;font-size:.95rem;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:700;box-shadow:var(--shadow);transition:background .15s}
.zoom-btn:hover{background:var(--accent);color:#fff}
#popup{position:absolute;background:var(--surface);border:1.5px solid var(--border);border-radius:12px;padding:9px 13px;font-size:.78rem;box-shadow:var(--shadow);pointer-events:none;display:none;z-index:50;min-width:135px;max-width:195px}
#popup h4{font-family:'Syne',sans-serif;font-weight:700;font-size:.86rem;margin-bottom:3px}
#popup p{color:var(--muted);font-size:.73rem;line-height:1.4}
#popup .view-3d-hint{margin-top:6px;font-size:.7rem;color:var(--accent);font-style:italic}

/* â”€â”€ SIDE PANEL â”€â”€ */
.side-panel{background:var(--surface);display:flex;flex-direction:column;overflow-y:auto}
.panel-header{padding:13px 15px 9px;border-bottom:1.5px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.panel-header h3{font-family:'Syne',sans-serif;font-weight:700;font-size:.9rem}
.panel-plus{width:26px;height:26px;border-radius:7px;background:var(--bg);border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:.95rem;cursor:pointer;transition:background .15s}
.panel-plus:hover{background:var(--accent);color:#fff}
.route-info{margin:9px 15px 0;padding:9px 11px;background:#eff6ff;border:1.5px solid #bfdbfe;border-radius:10px;font-size:.77rem;display:none}
.route-info.visible{display:block}
.route-info strong{font-family:'Syne',sans-serif;color:var(--accent)}
.location-list{padding:11px 15px;flex:1}
.loc-section-title{font-family:'Syne',sans-serif;font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin:9px 0 5px}
.loc-card{display:flex;align-items:center;gap:8px;padding:7px 9px;border-radius:9px;cursor:pointer;transition:background .15s;margin-bottom:3px;border:1.5px solid transparent}
.loc-card:hover{background:#eff6ff;border-color:#bfdbfe}
.loc-card.active{background:#eff6ff;border-color:var(--accent)}
.loc-icon{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:.95rem;flex-shrink:0}
.loc-info{flex:1;min-width:0}
.loc-name{font-family:'Syne',sans-serif;font-weight:600;font-size:.78rem}
.loc-desc{font-size:.68rem;color:var(--muted);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.loc-3d-badge{font-size:.62rem;background:#eff6ff;color:var(--accent);border:1px solid #bfdbfe;border-radius:4px;padding:1px 5px;margin-left:4px;font-family:'Syne',sans-serif;font-weight:700;flex-shrink:0}
.layer-toggles{padding:7px 15px 4px;border-top:1.5px solid var(--border);display:none}
.toggle-row{display:flex;align-items:center;justify-content:space-between;font-size:.76rem;margin-bottom:7px}
.toggle-label{color:var(--muted)}
.toggle{width:30px;height:16px;background:var(--border);border-radius:8px;cursor:pointer;position:relative;transition:background .2s}
.toggle.on{background:var(--accent)}
.toggle::after{content:'';position:absolute;top:2px;left:2px;width:12px;height:12px;border-radius:50%;background:#fff;transition:left .2s}
.toggle.on::after{left:16px}
.footer-tag{padding:9px 15px;border-top:1.5px solid var(--border);font-size:.68rem;color:var(--muted);text-align:center;font-style:italic}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   3D MAIN BLOCK MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#modal-overlay{position:fixed;inset:0;background:rgba(15,10,5,.65);backdrop-filter:blur(4px);z-index:1000;display:none;align-items:center;justify-content:center}
#modal-overlay.open{display:flex}
#modal-box{background:var(--surface);border-radius:18px;width:min(720px,95vw);max-height:90vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.modal-top{padding:16px 20px 12px;border-bottom:1.5px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-top h2{font-family:'Syne',sans-serif;font-weight:800;font-size:1.1rem}
.modal-top p{font-size:.75rem;color:var(--muted);margin-top:2px}
.modal-close{width:32px;height:32px;border-radius:8px;background:var(--bg);border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:1.1rem;cursor:pointer;flex-shrink:0}
.modal-close:hover{background:#fee2e2;color:#e11d48}
.modal-body{flex:1;display:flex;overflow:hidden;min-height:0}

/* 3D canvas side */
.block-3d{flex:0 0 55%;background:#1a1a2e;position:relative;overflow:hidden}
#threeCanvas{width:100%;height:100%;display:block}
.floor-hint{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,.12);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:5px 12px;font-size:.7rem;color:#fff;white-space:nowrap;pointer-events:none}

/* Floor info side */
.floor-info{flex:1;overflow-y:auto;padding:16px}
.floor-tabs{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap}
.ftab{padding:6px 14px;border-radius:8px;font-family:'Syne',sans-serif;font-weight:600;font-size:.75rem;cursor:pointer;border:1.5px solid var(--border);background:var(--bg);color:var(--muted);transition:all .2s}
.ftab.active{color:#fff;border-color:transparent}
.floor-detail{display:none}
.floor-detail.visible{display:block}
.floor-detail h3{font-family:'Syne',sans-serif;font-weight:700;font-size:1rem;margin-bottom:4px}
.floor-detail .floor-tag{display:inline-block;font-size:.68rem;padding:2px 8px;border-radius:20px;color:#fff;margin-bottom:10px;font-family:'Syne',sans-serif;font-weight:600}
.room-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
.room-card{background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:10px 12px}
.room-card .room-icon{font-size:1.3rem;margin-bottom:4px}
.room-card .room-name{font-family:'Syne',sans-serif;font-weight:700;font-size:.78rem}
.room-card .room-desc{font-size:.68rem;color:var(--muted);margin-top:2px;line-height:1.4}
.dept-banner{border-radius:10px;padding:12px 14px;margin-bottom:10px;color:#fff}
.dept-banner h4{font-family:'Syne',sans-serif;font-weight:700;font-size:.9rem}
.dept-banner p{font-size:.72rem;opacity:.85;margin-top:3px}

@media(max-width:600px){
  .modal-body{flex-direction:column}
  .block-3d{flex:0 0 220px}
  .main{grid-template-columns:1fr;grid-template-rows:55vh auto;height:auto}
  .map-area{border-right:none;border-bottom:1.5px solid var(--border)}
  .btn-signin{margin-left:0}
}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="logo">Campus<span>Nav</span></div>
  <div class="search-wrap">
    <span class="search-icon">ğŸ”</span>
    <input type="text" id="searchInput" placeholder="Search locationsâ€¦" autocomplete="off">
    <div id="autocomplete"></div>
  </div>
  <select id="fromSelect"><option value="">Current Location</option></select>
  <select id="toSelect"><option value="">Destination</option></select>
  <button class="btn btn-route" onclick="doRoute()">â†— Get Route</button>
  <button class="btn btn-clear" onclick="clearRoute()">âœ• Clear</button>
  <button class="btn btn-signin">Sign In</button>
</div>

<!-- MAIN -->
<div class="main">
  <div class="map-area" id="mapArea">
    <canvas id="campusCanvas"></canvas>
    <div id="popup">
      <h4 id="popupName"></h4>
      <p id="popupDesc"></p>
      <div class="view-3d-hint" id="popup3dHint" style="display:none">ğŸ¢ Click again to view 3D floors</div>
    </div>
    <div class="zoom-controls">
      <button class="zoom-btn" onclick="zoomMap(1.2)">+</button>
      <button class="zoom-btn" onclick="zoomMap(0.83)">âˆ’</button>
      <button class="zoom-btn" onclick="resetView()">âŒ‚</button>
    </div>
  </div>

  <div class="side-panel">
    <div class="panel-header">
      <h3>Campus Map</h3>
      <div class="panel-plus" id="plusBtn">+</div>
    </div>
    <div class="route-info" id="routeInfo"><strong>Route Active</strong><br><span id="routeDesc"></span></div>
    <div class="location-list" id="locList"></div>
    <div class="layer-toggles" id="layerToggles">
      <div class="loc-section-title" style="margin-top:4px">Layers</div>
      <div class="toggle-row"><span class="toggle-label">Building Labels</span><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
      <div class="toggle-row"><span class="toggle-label">Trees</span><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
      <div class="toggle-row"><span class="toggle-label">Crowd Status</span><div class="toggle" onclick="this.classList.toggle('on')"></div></div>
    </div>
    <div class="footer-tag">Scan QR Â· Search Â· Navigate Â· Arrive</div>
  </div>
</div>

<!-- 3D MAIN BLOCK MODAL -->
<div id="modal-overlay" onclick="closeModal(event)">
  <div id="modal-box">
    <div class="modal-top">
      <div>
        <h2>ğŸ›ï¸ Main Block â€” 3D View</h2>
        <p>Click a floor to explore departments Â· Drag to rotate Â· Scroll to zoom</p>
      </div>
      <div class="modal-close" onclick="closeModalDirect()">âœ•</div>
    </div>
    <div class="modal-body">

      <!-- Three.js 3D Building -->
      <div class="block-3d">
        <canvas id="threeCanvas"></canvas>
        <div class="floor-hint">ğŸ–± Drag to rotate Â· Scroll to zoom</div>
      </div>

      <!-- Floor Details Panel -->
      <div class="floor-info">
        <div class="floor-tabs">
          <div class="ftab active" style="background:#6b7280" data-floor="0" onclick="selectFloor(0)">Ground</div>
          <div class="ftab" data-floor="1" onclick="selectFloor(1)">1st Floor</div>
          <div class="ftab" data-floor="2" onclick="selectFloor(2)">2nd Floor</div>
          <div class="ftab" data-floor="3" onclick="selectFloor(3)">3rd Floor</div>
        </div>

        <!-- GROUND FLOOR -->
        <div class="floor-detail visible" id="floor-0">
          <div class="dept-banner" style="background:linear-gradient(135deg,#374151,#1f2937)">
            <h4>Ground Floor</h4>
            <p>Fitness, Admin & Common Areas</p>
          </div>
          <div class="floor-tag" style="background:#6b7280">G Â· Ground Level</div>
          <div class="room-grid">
            <div class="room-card"><div class="room-icon">ğŸ‹ï¸</div><div class="room-name">Gymnasium</div><div class="room-desc">Full-equipped gym Â· 6amâ€“9pm</div></div>
            <div class="room-card"><div class="room-icon">ğŸ¢</div><div class="room-name">Admin Office</div><div class="room-desc">College administration</div></div>
            <div class="room-card"><div class="room-icon">ğŸ“‹</div><div class="room-name">Notice Board</div><div class="room-desc">Announcements & updates</div></div>
            <div class="room-card"><div class="room-icon">ğŸšª</div><div class="room-name">Main Lobby</div><div class="room-desc">Reception & info desk</div></div>
            <div class="room-card"><div class="room-icon">ğŸš»</div><div class="room-name">Restrooms</div><div class="room-desc">Male & Female facilities</div></div>
            <div class="room-card"><div class="room-icon">ğŸ”’</div><div class="room-name">Security Room</div><div class="room-desc">Campus security post</div></div>
          </div>
        </div>

        <!-- 1ST FLOOR -->
        <div class="floor-detail" id="floor-1">
          <div class="dept-banner" style="background:linear-gradient(135deg,#1d4ed8,#2563eb)">
            <h4>1st Floor â€” EEE Department</h4>
            <p>Electrical & Electronics Engineering</p>
          </div>
          <div class="floor-tag" style="background:#2563eb">1F Â· First Floor</div>
          <div class="room-grid">
            <div class="room-card"><div class="room-icon">âš¡</div><div class="room-name">EEE Lab 1</div><div class="room-desc">Circuits & Electronics Lab</div></div>
            <div class="room-card"><div class="room-icon">ğŸ”Œ</div><div class="room-name">Power Systems Lab</div><div class="room-desc">High-voltage experiments</div></div>
            <div class="room-card"><div class="room-icon">ğŸ–¥ï¸</div><div class="room-name">Simulation Lab</div><div class="room-desc">MATLAB / ETAP tools</div></div>
            <div class="room-card"><div class="room-icon">ğŸ“š</div><div class="room-name">EEE Classrooms</div><div class="room-desc">Lecture halls A, B, C</div></div>
            <div class="room-card"><div class="room-icon">ğŸ‘¨â€ğŸ«</div><div class="room-name">Faculty Room</div><div class="room-desc">EEE department staff</div></div>
            <div class="room-card"><div class="room-icon">ğŸ“¦</div><div class="room-name">Equipment Store</div><div class="room-desc">Tools & instruments</div></div>
          </div>
        </div>

        <!-- 2ND FLOOR -->
        <div class="floor-detail" id="floor-2">
          <div class="dept-banner" style="background:linear-gradient(135deg,#059669,#10b981)">
            <h4>2nd Floor â€” CS & Robotics</h4>
            <p>Computer Science Â· Robotics & Automation</p>
          </div>
          <div class="floor-tag" style="background:#059669">2F Â· Second Floor</div>
          <div class="room-grid">
            <div class="room-card"><div class="room-icon">ğŸ’»</div><div class="room-name">CS Lab 1 & 2</div><div class="room-desc">Programming & OS labs</div></div>
            <div class="room-card"><div class="room-icon">ğŸ¤–</div><div class="room-name">Robotics Lab</div><div class="room-desc">Automation & IoT projects</div></div>
            <div class="room-card"><div class="room-icon">ğŸ§ </div><div class="room-name">AI / ML Lab</div><div class="room-desc">Deep learning workstations</div></div>
            <div class="room-card"><div class="room-icon">ğŸŒ</div><div class="room-name">Network Lab</div><div class="room-desc">CISCO, networking tools</div></div>
            <div class="room-card"><div class="room-icon">ğŸ“š</div><div class="room-name">CS Classrooms</div><div class="room-desc">Lecture halls D, E, F</div></div>
            <div class="room-card"><div class="room-icon">ğŸ‘¨â€ğŸ’»</div><div class="room-name">Project Room</div><div class="room-desc">Final year project area</div></div>
          </div>
        </div>

        <!-- 3RD FLOOR -->
        <div class="floor-detail" id="floor-3">
          <div class="dept-banner" style="background:linear-gradient(135deg,#9333ea,#7c3aed)">
            <h4>3rd Floor â€” EC Department</h4>
            <p>Electronics & Communication Engineering</p>
          </div>
          <div class="floor-tag" style="background:#7c3aed">3F Â· Third Floor</div>
          <div class="room-grid">
            <div class="room-card"><div class="room-icon">ğŸ“¡</div><div class="room-name">Communication Lab</div><div class="room-desc">Signal & RF systems</div></div>
            <div class="room-card"><div class="room-icon">ğŸ”§</div><div class="room-name">VLSI Lab</div><div class="room-desc">Chip design & FPGA</div></div>
            <div class="room-card"><div class="room-icon">ğŸ“»</div><div class="room-name">Antenna Lab</div><div class="room-desc">Microwave & antennas</div></div>
            <div class="room-card"><div class="room-icon">ğŸ–¥ï¸</div><div class="room-name">DSP Lab</div><div class="room-desc">Digital signal processing</div></div>
            <div class="room-card"><div class="room-icon">ğŸ“š</div><div class="room-name">EC Classrooms</div><div class="room-desc">Lecture halls G, H, I</div></div>
            <div class="room-card"><div class="room-icon">ğŸ‘©â€ğŸ«</div><div class="room-name">HOD Office</div><div class="room-desc">Head of EC Department</div></div>
          </div>
        </div>

      </div><!-- /floor-info -->
    </div><!-- /modal-body -->
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAMPUS DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CW=900, CH=860;

const buildings=[
  {label:"Men's Hostel",   x:20,  y:20,  w:110, h:190, c:'#c7d2fe'},
  {label:'MBA / MCA',      x:150, y:20,  w:160, h:110, c:'#fbcfe8'},
  {label:'Main Block\n(G/1st/2nd/3rd Floor)', x:20, y:350, w:230, h:270, c:'#bbf7d0', isMain:true},
  {label:'Lobby',          x:255, y:395, w:95,  h:75,  c:'#d1fae5'},
  {label:'Mech & AI',      x:460, y:20,  w:250, h:110, c:'#ddd6fe'},
  {label:'Basketball\nCourt',x:490,y:240, w:210, h:95,  c:'#fed7aa'},
  {label:'Volleyball\nCourt',x:490,y:355, w:210, h:85,  c:'#fef08a'},
  {label:'CCF',            x:530, y:460, w:110, h:155, c:'#e0e7ff'},
  {label:'Canteen',        x:595, y:635, w:120, h:105, c:'#ffedd5'},
  {label:'Parking\n(Two-Wheelers)',x:580,y:755,w:150, h:55, c:'#d1d5db'},
  {label:'Civil / BIO\n/ MED',x:750,y:685,w:130, h:120, c:'#bfdbfe'},
];

const locations=[
  {id:'gate',       name:'Main Gate',         desc:'Campus entrance / exit',       icon:'ğŸšª', c:'#dc2626', x:430, y:840},
  {id:'lobby',      name:'Main Lobby',         desc:'Reception & Info Desk',        icon:'ğŸ¢', c:'#059669', x:302, y:432},
  {id:'mainblock',  name:'Main Block',         desc:'Gym Â· EEE Â· CS/Robotics Â· EC', icon:'ğŸ›ï¸', c:'#16a34a', x:135, y:485, has3d:true},
  {id:'hostel',     name:"Men's Hostel",        desc:'Student Accommodation',        icon:'ğŸ ', c:'#4f46e5', x:75,  y:115},
  {id:'mba',        name:'MBA / MCA Block',    desc:'Management & CS Dept.',        icon:'ğŸ“š', c:'#db2777', x:230, y:75},
  {id:'mech',       name:'Mech & AI Block',    desc:'Mechanical & AI Dept.',        icon:'âš™ï¸', c:'#7c3aed', x:585, y:75},
  {id:'basketball', name:'Basketball Court',   desc:'Outdoor Sports Facility',      icon:'ğŸ€', c:'#ea580c', x:595, y:287},
  {id:'volleyball', name:'Volleyball Court',   desc:'Outdoor Sports Facility',      icon:'ğŸ', c:'#ca8a04', x:595, y:397},
  {id:'ccf',        name:'CCF Block',          desc:'Central Campus Facilities',    icon:'ğŸ”¬', c:'#0284c7', x:585, y:537},
  {id:'canteen',    name:'Canteen',            desc:'Food Court Â· 8amâ€“8pm',         icon:'ğŸ½ï¸', c:'#f97316', x:655, y:687},
  {id:'civil',      name:'Civil / BIO / MED', desc:'Civil, Bio & Medical Dept.',   icon:'ğŸ—ï¸', c:'#2563eb', x:815, y:745},
  {id:'parking',    name:'Parking Area',       desc:'Two-Wheelers Parking',         icon:'ğŸ›µ', c:'#6b7280', x:655, y:782},
];

const trees=[{x:435,y:185},{x:605,y:600},{x:500,y:755}];

// Road segments
const roads=[
  [{x:430,y:20},{x:430,y:840}],           // main N-S spine
  [{x:20,y:810},{x:880,y:810}],            // bottom E-W
  [{x:150,y:20},{x:150,y:350}],            // west side vertical
  [{x:20,y:210},{x:430,y:210}],            // upper west horizontal
  [{x:580,y:130},{x:580,y:810}],           // east vertical
  [{x:310,y:130},{x:710,y:130}],           // mech top horizontal
  // *** Direct path to Lobby from main road ***
  [{x:430,y:432},{x:360,y:432},{x:350,y:432}],   // lobby direct connector
  [{x:350,y:350},{x:350,y:620},{x:20,y:620}],    // main block loop
];

// Route waypoints
const routeMap={
  'gate-lobby':       [{x:430,y:840},{x:430,y:432},{x:350,y:432},{x:302,y:432}],
  'gate-mainblock':   [{x:430,y:840},{x:430,y:485},{x:350,y:485},{x:250,y:485},{x:135,y:485}],
  'gate-hostel':      [{x:430,y:840},{x:430,y:210},{x:150,y:210},{x:150,y:130},{x:75,y:130}],
  'gate-mba':         [{x:430,y:840},{x:430,y:210},{x:310,y:210},{x:230,y:130},{x:230,y:75}],
  'gate-mech':        [{x:430,y:840},{x:430,y:130},{x:580,y:130},{x:585,y:75}],
  'gate-basketball':  [{x:430,y:840},{x:430,y:287},{x:580,y:287},{x:595,y:287}],
  'gate-volleyball':  [{x:430,y:840},{x:430,y:397},{x:580,y:397},{x:595,y:397}],
  'gate-ccf':         [{x:430,y:840},{x:430,y:537},{x:580,y:537},{x:585,y:537}],
  'gate-canteen':     [{x:430,y:840},{x:430,y:810},{x:655,y:810},{x:655,y:687}],
  'gate-civil':       [{x:430,y:840},{x:430,y:810},{x:815,y:810},{x:815,y:745}],
  'gate-parking':     [{x:430,y:840},{x:430,y:810},{x:655,y:810},{x:655,y:782}],
  'lobby-mainblock':  [{x:302,y:432},{x:350,y:432},{x:350,y:485},{x:250,y:485},{x:135,y:485}],
  'lobby-hostel':     [{x:302,y:432},{x:302,y:350},{x:150,y:350},{x:150,y:130},{x:75,y:130}],
  'lobby-mba':        [{x:302,y:432},{x:302,y:210},{x:230,y:130},{x:230,y:75}],
  'lobby-mech':       [{x:302,y:432},{x:430,y:432},{x:430,y:130},{x:580,y:130},{x:585,y:75}],
  'lobby-basketball': [{x:302,y:432},{x:430,y:432},{x:430,y:287},{x:580,y:287},{x:595,y:287}],
  'lobby-volleyball': [{x:302,y:432},{x:430,y:432},{x:580,y:432},{x:595,y:397}],
  'lobby-ccf':        [{x:302,y:432},{x:430,y:432},{x:430,y:537},{x:580,y:537}],
  'lobby-canteen':    [{x:302,y:432},{x:430,y:432},{x:430,y:810},{x:655,y:810},{x:655,y:687}],
  'lobby-civil':      [{x:302,y:432},{x:430,y:432},{x:430,y:810},{x:815,y:810},{x:815,y:745}],
  'lobby-parking':    [{x:302,y:432},{x:430,y:432},{x:430,y:810},{x:655,y:810},{x:655,y:782}],
  'mainblock-hostel': [{x:135,y:485},{x:150,y:485},{x:150,y:130},{x:75,y:130}],
  'mainblock-mba':    [{x:135,y:485},{x:150,y:485},{x:150,y:210},{x:230,y:130},{x:230,y:75}],
  'mba-mech':         [{x:230,y:75},{x:430,y:75},{x:585,y:75}],
  'mba-hostel':       [{x:230,y:75},{x:150,y:75},{x:150,y:130},{x:75,y:130}],
  'mech-basketball':  [{x:585,y:75},{x:580,y:130},{x:580,y:287},{x:595,y:287}],
  'mech-volleyball':  [{x:585,y:75},{x:580,y:130},{x:580,y:397},{x:595,y:397}],
  'mech-ccf':         [{x:585,y:75},{x:580,y:537},{x:585,y:537}],
  'mech-canteen':     [{x:585,y:75},{x:580,y:810},{x:655,y:810},{x:655,y:687}],
  'mech-civil':       [{x:585,y:75},{x:580,y:810},{x:815,y:810},{x:815,y:745}],
  'basketball-volleyball':[{x:595,y:287},{x:580,y:287},{x:580,y:397},{x:595,y:397}],
  'basketball-ccf':   [{x:595,y:287},{x:580,y:287},{x:580,y:537}],
  'volleyball-ccf':   [{x:595,y:397},{x:580,y:460},{x:580,y:537}],
  'ccf-canteen':      [{x:585,y:537},{x:580,y:635},{x:655,y:687}],
  'canteen-civil':    [{x:655,y:687},{x:655,y:810},{x:815,y:810},{x:815,y:745}],
  'canteen-parking':  [{x:655,y:687},{x:655,y:755}],
  'civil-parking':    [{x:815,y:745},{x:815,y:810},{x:655,y:810},{x:655,y:755}],
};
// Auto reverse
Object.keys(routeMap).forEach(k=>{
  const[a,b]=k.split('-'), rev=`${b}-${a}`;
  if(!routeMap[rev]) routeMap[rev]=[...routeMap[k]].reverse();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 2D MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas=document.getElementById('campusCanvas');
const ctx=canvas.getContext('2d');
const mapArea=document.getElementById('mapArea');
let scale=1,offsetX=0,offsetY=0,isDragging=false,dragStart={x:0,y:0};
let activeRoute=null,highlightedId=null,activeCardId=null;
let mouseDownPos={x:0,y:0};

function resizeCanvas(){canvas.width=mapArea.clientWidth;canvas.height=mapArea.clientHeight;}
function scr(lx,ly){return{x:lx*scale+offsetX,y:ly*scale+offsetY};}

function drawBG(){
  ctx.fillStyle='#c8e6c9';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='rgba(0,0,0,0.035)';
  for(let gx=(offsetX%40+40)%40;gx<canvas.width;gx+=40)
    for(let gy=(offsetY%40+40)%40;gy<canvas.height;gy+=40){
      ctx.beginPath();ctx.arc(gx,gy,1.5,0,Math.PI*2);ctx.fill();
    }
}

function drawRoads(){
  roads.forEach(pts=>{
    const sp=pts.map(p=>scr(p.x,p.y));
    ctx.strokeStyle='rgba(0,0,0,0.07)';ctx.lineWidth=22*scale;ctx.lineCap='round';ctx.lineJoin='round';
    ctx.beginPath();sp.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();
    ctx.strokeStyle='#b0aaa4';ctx.lineWidth=18*scale;
    ctx.beginPath();sp.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();
    ctx.strokeStyle='rgba(255,255,255,0.35)';ctx.lineWidth=1.5*scale;
    ctx.setLineDash([10*scale,8*scale]);
    ctx.beginPath();sp.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();
    ctx.setLineDash([]);
  });
}

function drawBuildings(){
  buildings.forEach(b=>{
    const s=scr(b.x,b.y);const bw=b.w*scale,bh=b.h*scale;
    ctx.shadowColor='rgba(0,0,0,0.15)';ctx.shadowBlur=10*scale;ctx.shadowOffsetY=4*scale;
    ctx.fillStyle=b.c;ctx.strokeStyle='rgba(0,0,0,0.2)';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.roundRect(s.x,s.y,bw,bh,5*scale);ctx.fill();ctx.stroke();
    ctx.shadowBlur=0;ctx.shadowOffsetY=0;

    // 3D indicator on main block
    if(b.isMain && scale>0.5){
      ctx.fillStyle='rgba(37,99,235,0.15)';
      ctx.beginPath();ctx.roundRect(s.x,s.y,bw,bh,5*scale);ctx.fill();
      // floor lines
      const floorH=bh/4;
      ctx.strokeStyle='rgba(37,99,235,0.3)';ctx.lineWidth=1*scale;ctx.setLineDash([4*scale,3*scale]);
      [1,2,3].forEach(f=>{
        ctx.beginPath();ctx.moveTo(s.x,s.y+f*floorH);ctx.lineTo(s.x+bw,s.y+f*floorH);ctx.stroke();
      });
      ctx.setLineDash([]);
    }

    const lines=b.label.split('\n');
    const fs=Math.max(7,Math.min(11,9.5*scale));
    ctx.font=`600 ${fs}px 'DM Sans',sans-serif`;
    ctx.fillStyle='rgba(0,0,0,0.65)';ctx.textAlign='center';ctx.textBaseline='middle';
    const lh=fs*1.4;
    const sy0=s.y+bh/2-(lines.length-1)*lh/2;
    lines.forEach((line,i)=>ctx.fillText(line,s.x+bw/2,sy0+i*lh));

    // 3D badge
    if(b.isMain && scale>0.55){
      const badgeW=38*scale,badgeH=13*scale;
      const bx2=s.x+bw/2-badgeW/2,by2=s.y+bh-badgeH-6*scale;
      ctx.fillStyle='#2563eb';ctx.beginPath();ctx.roundRect(bx2,by2,badgeW,badgeH,4*scale);ctx.fill();
      ctx.fillStyle='#fff';ctx.font=`bold ${Math.max(6,7.5*scale)}px 'Syne',sans-serif`;
      ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText('VIEW 3D',s.x+bw/2,by2+badgeH/2);
    }
  });
}

function drawTrees(){
  trees.forEach(t=>{
    const s=scr(t.x,t.y);const r=13*scale;
    ctx.fillStyle='#7c4a1e';ctx.fillRect(s.x-2*scale,s.y,4*scale,8*scale);
    ctx.shadowColor='rgba(0,0,0,0.1)';ctx.shadowBlur=6*scale;
    ctx.beginPath();ctx.arc(s.x,s.y,r,0,Math.PI*2);
    ctx.fillStyle='#4ade80';ctx.fill();ctx.strokeStyle='#16a34a';ctx.lineWidth=1.5;ctx.stroke();
    ctx.beginPath();ctx.arc(s.x-r*.25,s.y-r*.25,r*.38,0,Math.PI*2);
    ctx.fillStyle='rgba(255,255,255,0.22)';ctx.fill();ctx.shadowBlur=0;
  });
}

function drawGate(){
  const s=scr(430,840);
  ctx.strokeStyle='#888';ctx.lineWidth=2*scale;
  ctx.beginPath();ctx.moveTo(s.x-50*scale,s.y);ctx.lineTo(s.x+50*scale,s.y);ctx.stroke();
  ctx.fillStyle='#374151';
  ctx.fillRect(s.x-32*scale,s.y-18*scale,7*scale,18*scale);
  ctx.fillRect(s.x+25*scale,s.y-18*scale,7*scale,18*scale);
  ctx.beginPath();ctx.arc(s.x,s.y-2*scale,28*scale,Math.PI,0,false);
  ctx.strokeStyle='#1a1714';ctx.lineWidth=3*scale;ctx.stroke();
  ctx.fillStyle='#1a1714';
  ctx.font=`bold ${10*scale}px 'Syne',sans-serif`;
  ctx.textAlign='center';ctx.textBaseline='top';
  ctx.fillText('MAIN GATE',s.x,s.y+6*scale);
}

// Direct lobby sign
function drawLobbyArrow(){
  if(scale<0.6) return;
  const s=scr(390,432);
  ctx.fillStyle='#059669';
  ctx.font=`bold ${9*scale}px 'Syne',sans-serif`;
  ctx.textAlign='right';ctx.textBaseline='middle';
  ctx.fillText('â† LOBBY',s.x,s.y);
}

function drawActiveRoute(){
  if(!activeRoute||activeRoute.length<2) return;
  const pts=activeRoute.map(p=>scr(p.x,p.y));
  ctx.strokeStyle='rgba(37,99,235,0.22)';ctx.lineWidth=11*scale;ctx.lineCap='round';ctx.lineJoin='round';
  ctx.beginPath();pts.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();
  ctx.strokeStyle='#2563eb';ctx.lineWidth=3.5*scale;ctx.setLineDash([9*scale,6*scale]);
  ctx.beginPath();pts.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();
  ctx.setLineDash([]);
  const tl=pLen(activeRoute),t=(Date.now()%1400)/1400;
  const dp=pAt(activeRoute,t*tl),ds=scr(dp.x,dp.y);
  ctx.beginPath();ctx.arc(ds.x,ds.y,6*scale,0,Math.PI*2);
  ctx.fillStyle='#2563eb';ctx.strokeStyle='#fff';ctx.lineWidth=2*scale;ctx.fill();ctx.stroke();
  [[pts[0],'#16a34a'],[pts[pts.length-1],'#e11d48']].forEach(([p,col])=>{
    ctx.beginPath();ctx.arc(p.x,p.y,8*scale,0,Math.PI*2);
    ctx.fillStyle=col;ctx.strokeStyle='#fff';ctx.lineWidth=2.5*scale;ctx.fill();ctx.stroke();
  });
}

function pLen(pts){let l=0;for(let i=1;i<pts.length;i++)l+=Math.hypot(pts[i].x-pts[i-1].x,pts[i].y-pts[i-1].y);return l;}
function pAt(pts,d){let r=d;for(let i=1;i<pts.length;i++){const s=Math.hypot(pts[i].x-pts[i-1].x,pts[i].y-pts[i-1].y);if(r<=s){const t=r/s;return{x:pts[i-1].x+(pts[i].x-pts[i-1].x)*t,y:pts[i-1].y+(pts[i].y-pts[i-1].y)*t};}r-=s;}return pts[pts.length-1];}

function drawMarkers(){
  locations.forEach(loc=>{
    const s=scr(loc.x,loc.y);
    const isAct=highlightedId===loc.id||activeCardId===loc.id;
    const r=(isAct?13:10)*scale;
    if(isAct){ctx.beginPath();ctx.arc(s.x,s.y-r*.2,r+6*scale,0,Math.PI*2);ctx.fillStyle=loc.c+'33';ctx.fill();}
    ctx.shadowColor='rgba(0,0,0,0.22)';ctx.shadowBlur=8;
    ctx.beginPath();ctx.arc(s.x,s.y-r*.2,r,0,Math.PI*2);
    ctx.fillStyle=loc.c;ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=2*scale;ctx.stroke();
    ctx.beginPath();ctx.moveTo(s.x-r*.4,s.y+r*.6);ctx.lineTo(s.x+r*.4,s.y+r*.6);ctx.lineTo(s.x,s.y+r*1.5);
    ctx.closePath();ctx.fillStyle=loc.c;ctx.fill();ctx.shadowBlur=0;
    if(scale>0.55){
      const fs=Math.max(7.5,9*scale);
      ctx.font=`${isAct?'bold ':''}${fs}px 'DM Sans',sans-serif`;
      ctx.textAlign='center';ctx.textBaseline='top';
      const tw=ctx.measureText(loc.name).width,ty=s.y+r*1.6;
      ctx.fillStyle='rgba(255,255,255,0.88)';ctx.fillRect(s.x-tw/2-3,ty-1,tw+6,fs+4);
      ctx.fillStyle='#1a1714';ctx.fillText(loc.name,s.x,ty);
      // 3D badge on main block marker
      if(loc.has3d){
        ctx.fillStyle='#2563eb';
        const bw=24*scale,bh=10*scale,bx=s.x-bw/2,by=ty+fs+5;
        ctx.beginPath();ctx.roundRect(bx,by,bw,bh,3*scale);ctx.fill();
        ctx.fillStyle='#fff';ctx.font=`bold ${Math.max(5,6.5*scale)}px 'Syne',sans-serif`;
        ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('3D',s.x,by+bh/2);
      }
    }
  });
}

function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawBG();drawRoads();drawBuildings();drawTrees();drawGate();drawLobbyArrow();drawActiveRoute();drawMarkers();
}
function animate(){render();requestAnimationFrame(animate);}

// â”€â”€â”€ PAN / ZOOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function zoomMap(f){
  const cx=canvas.width/2,cy=canvas.height/2;
  offsetX=cx-(cx-offsetX)*f;offsetY=cy-(cy-offsetY)*f;
  scale=Math.max(.3,Math.min(4,scale*f));
}
function resetView(){
  const sx=canvas.width/CW,sy=canvas.height/CH;
  scale=Math.min(sx,sy)*.90;
  offsetX=(canvas.width-CW*scale)/2;
  offsetY=(canvas.height-CH*scale)/2;
}

mapArea.addEventListener('mousedown',e=>{
  mouseDownPos={x:e.clientX,y:e.clientY};
  dragStart={x:e.clientX-offsetX,y:e.clientY-offsetY};
  isDragging=false;mapArea.style.cursor='grabbing';
  mapArea.addEventListener('mousemove',onMove);
});
function onMove(e){isDragging=true;offsetX=e.clientX-dragStart.x;offsetY=e.clientY-dragStart.y;}
window.addEventListener('mouseup',e=>{
  mapArea.removeEventListener('mousemove',onMove);
  mapArea.style.cursor='grab';
  if(Math.hypot(e.clientX-mouseDownPos.x,e.clientY-mouseDownPos.y)<5) handleClick(e);
  isDragging=false;
});
mapArea.addEventListener('wheel',e=>{
  e.preventDefault();const f=e.deltaY<0?1.1:.91;
  const r=mapArea.getBoundingClientRect();const mx=e.clientX-r.left,my=e.clientY-r.top;
  offsetX=mx-(mx-offsetX)*f;offsetY=my-(my-offsetY)*f;scale=Math.max(.3,Math.min(4,scale*f));
},{passive:false});

let lastTouches=[];
mapArea.addEventListener('touchstart',e=>{
  lastTouches=Array.from(e.touches).map(t=>({x:t.clientX,y:t.clientY}));
  if(e.touches.length===1)dragStart={x:e.touches[0].clientX-offsetX,y:e.touches[0].clientY-offsetY};
});
mapArea.addEventListener('touchmove',e=>{
  e.preventDefault();
  if(e.touches.length===1){offsetX=e.touches[0].clientX-dragStart.x;offsetY=e.touches[0].clientY-dragStart.y;}
  else if(e.touches.length===2){
    const cur=Array.from(e.touches).map(t=>({x:t.clientX,y:t.clientY}));
    const pd=Math.hypot(lastTouches[0].x-lastTouches[1].x,lastTouches[0].y-lastTouches[1].y);
    const cd=Math.hypot(cur[0].x-cur[1].x,cur[0].y-cur[1].y);const f=cd/pd;
    const r=mapArea.getBoundingClientRect();const mx=(cur[0].x+cur[1].x)/2-r.left,my=(cur[0].y+cur[1].y)/2-r.top;
    offsetX=mx-(mx-offsetX)*f;offsetY=my-(my-offsetY)*f;scale=Math.max(.3,Math.min(4,scale*f));lastTouches=cur;
  }
},{passive:false});

// â”€â”€â”€ POPUP & CLICK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const popup=document.getElementById('popup');
let lastClickedId=null;
function handleClick(e){
  const rect=mapArea.getBoundingClientRect();
  const mx=e.clientX-rect.left,my=e.clientY-rect.top;
  let hit=null;
  locations.forEach(loc=>{const s=scr(loc.x,loc.y);if(Math.hypot(mx-s.x,my-(s.y-10*scale))<18*scale)hit=loc;});
  // also check main block building click
  if(!hit){
    const mb=buildings.find(b=>b.isMain);
    if(mb){const s=scr(mb.x,mb.y);if(mx>=s.x&&mx<=s.x+mb.w*scale&&my>=s.y&&my<=s.y+mb.h*scale){openModal();return;}}
  }
  if(hit){
    if(lastClickedId===hit.id&&hit.has3d){openModal();return;}
    lastClickedId=hit.id;
    document.getElementById('popupName').textContent=hit.name;
    document.getElementById('popupDesc').textContent=hit.desc;
    document.getElementById('popup3dHint').style.display=hit.has3d?'block':'none';
    popup.style.display='block';
    let px=e.clientX-rect.left+14,py=e.clientY-rect.top-55;
    if(px+200>canvas.width)px=e.clientX-rect.left-214;
    popup.style.left=px+'px';popup.style.top=Math.max(0,py)+'px';
    highlightedId=hit.id;setActiveCard(hit.id);
  } else {
    popup.style.display='none';highlightedId=null;lastClickedId=null;
  }
}

// â”€â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const searchInput=document.getElementById('searchInput');
const autocomplete=document.getElementById('autocomplete');
searchInput.addEventListener('input',()=>{
  const q=searchInput.value.trim().toLowerCase();autocomplete.innerHTML='';
  if(!q){autocomplete.classList.remove('visible');return;}
  const matches=locations.filter(l=>l.name.toLowerCase().includes(q)||l.desc.toLowerCase().includes(q));
  if(!matches.length){autocomplete.classList.remove('visible');return;}
  matches.forEach(loc=>{
    const div=document.createElement('div');div.className='suggest-item';
    div.innerHTML=`<span class="suggest-dot" style="background:${loc.c}"></span>${loc.name}`;
    div.onclick=()=>{searchInput.value=loc.name;autocomplete.classList.remove('visible');highlightedId=loc.id;setActiveCard(loc.id);panTo(loc.x,loc.y);popup.style.display='none';};
    autocomplete.appendChild(div);
  });
  autocomplete.classList.add('visible');
});
document.addEventListener('click',e=>{if(!e.target.closest('.search-wrap'))autocomplete.classList.remove('visible');});

// â”€â”€â”€ ROUTING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doRoute(){
  const from=document.getElementById('fromSelect').value;
  const to=document.getElementById('toSelect').value;
  if(!from||!to||from===to){alert('Select different origin and destination.');return;}
  const key=`${from}-${to}`;activeRoute=routeMap[key]||null;
  const fl=locations.find(l=>l.id===from),tl=locations.find(l=>l.id===to);
  const ri=document.getElementById('routeInfo');ri.classList.add('visible');
  if(activeRoute){
    const dist=pLen(activeRoute),mins=Math.max(1,Math.round(dist/65));
    document.getElementById('routeDesc').textContent=`${fl.name} â†’ ${tl.name} Â· ~${mins} min walk`;
    const mid=activeRoute[Math.floor(activeRoute.length/2)];panTo(mid.x,mid.y);
  } else {document.getElementById('routeDesc').textContent='Direct path not mapped yet.';}
}
function clearRoute(){activeRoute=null;document.getElementById('routeInfo').classList.remove('visible');document.getElementById('fromSelect').value='';document.getElementById('toSelect').value='';}

// â”€â”€â”€ SIDE PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPanel(){
  const fs=document.getElementById('fromSelect'),ts=document.getElementById('toSelect');
  const container=document.getElementById('locList');
  locations.forEach(loc=>{
    [fs,ts].forEach(sel=>{const o=document.createElement('option');o.value=loc.id;o.textContent=loc.name;sel.appendChild(o);});
  });
  const sections={
    'Academic':['mainblock','mba','mech','civil','ccf'],
    'Sports & Facilities':['basketball','volleyball','canteen','parking'],
    'Access & Stay':['gate','lobby','hostel']
  };
  Object.entries(sections).forEach(([sec,ids])=>{
    const t=document.createElement('div');t.className='loc-section-title';t.textContent=sec;container.appendChild(t);
    ids.forEach(id=>{
      const loc=locations.find(l=>l.id===id);if(!loc)return;
      const div=document.createElement('div');div.className='loc-card';div.id=`card-${loc.id}`;
      div.innerHTML=`<div class="loc-icon" style="background:${loc.c}22">${loc.icon}</div>
        <div class="loc-info"><div class="loc-name">${loc.name}${loc.has3d?'<span class="loc-3d-badge">3D</span>':''}</div><div class="loc-desc">${loc.desc}</div></div>`;
      div.onclick=()=>{setActiveCard(loc.id);panTo(loc.x,loc.y);highlightedId=loc.id;popup.style.display='none';if(loc.has3d)openModal();};
      container.appendChild(div);
    });
  });
}
function setActiveCard(id){
  activeCardId=id;
  document.querySelectorAll('.loc-card').forEach(c=>c.classList.remove('active'));
  const card=document.getElementById(`card-${id}`);
  if(card){card.classList.add('active');card.scrollIntoView({behavior:'smooth',block:'nearest'});}
}
function panTo(lx,ly){
  const tx=canvas.width/2-lx*scale,ty=canvas.height/2-ly*scale;
  const sx=offsetX,sy=offsetY;let start=null;
  function step(ts){if(!start)start=ts;const t=Math.min((ts-start)/420,1);const e2=1-Math.pow(1-t,3);offsetX=sx+(tx-sx)*e2;offsetY=sy+(ty-sy)*e2;if(t<1)requestAnimationFrame(step);}
  requestAnimationFrame(step);
}
document.getElementById('plusBtn').addEventListener('click',()=>{
  const lt=document.getElementById('layerToggles');lt.style.display=lt.style.display==='none'?'block':'none';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3D MAIN BLOCK (Three.js via CDN)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let threeInitialized=false;
let threeRenderer,threeScene,threeCamera,threeAnimId;
let selectedFloor=0;
let floorMeshes=[];

const floorColors=[0x94a3b8,0x3b82f6,0x10b981,0x8b5cf6]; // G, 1, 2, 3
const floorNames=['Ground','1st Floor','2nd Floor','3rd Floor'];
const floorColorHex=['#6b7280','#2563eb','#059669','#7c3aed'];

function openModal(){
  document.getElementById('modal-overlay').classList.add('open');
  if(!threeInitialized) initThree();
  selectFloor(0);
}
function closeModal(e){if(e.target===document.getElementById('modal-overlay'))closeModalDirect();}
function closeModalDirect(){
  document.getElementById('modal-overlay').classList.remove('open');
}

function initThree(){
  threeInitialized=true;
  const c=document.getElementById('threeCanvas');
  const w=c.parentElement.clientWidth,h=c.parentElement.clientHeight;

  threeRenderer=new THREE.WebGLRenderer({canvas:c,antialias:true,alpha:false});
  threeRenderer.setSize(w,h);
  threeRenderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  threeRenderer.shadowMap.enabled=true;
  threeRenderer.setClearColor(0x1a1a2e);

  threeScene=new THREE.Scene();
  threeScene.fog=new THREE.Fog(0x1a1a2e,20,60);

  threeCamera=new THREE.PerspectiveCamera(45,w/h,0.1,100);
  threeCamera.position.set(8,10,12);
  threeCamera.lookAt(0,2,0);

  // Lights
  const ambient=new THREE.AmbientLight(0xffffff,0.5);threeScene.add(ambient);
  const sun=new THREE.DirectionalLight(0xfff5e0,1.2);sun.position.set(10,20,10);sun.castShadow=true;threeScene.add(sun);
  const fill=new THREE.DirectionalLight(0x8888ff,0.3);fill.position.set(-8,5,-5);threeScene.add(fill);

  // Ground plane
  const ground=new THREE.Mesh(new THREE.PlaneGeometry(30,30),new THREE.MeshLambertMaterial({color:0x2d4a1e}));
  ground.rotation.x=-Math.PI/2;ground.position.y=-0.05;ground.receiveShadow=true;threeScene.add(ground);

  // Grid
  const grid=new THREE.GridHelper(30,30,0x3a5a2a,0x3a5a2a);grid.position.y=0.01;threeScene.add(grid);

  // Build the 4-floor building
  floorMeshes=[];
  const bW=5,bD=3.5,flH=1.8;
  for(let f=0;f<4;f++){
    const geo=new THREE.BoxGeometry(bW,flH,bD);
    const mat=new THREE.MeshLambertMaterial({color:floorColors[f],transparent:true,opacity:0.85});
    const mesh=new THREE.Mesh(geo,mat);
    mesh.position.set(0,f*flH+flH/2,0);
    mesh.castShadow=true;mesh.receiveShadow=true;
    mesh.userData={floor:f};
    threeScene.add(mesh);floorMeshes.push(mesh);

    // Floor edges
    const edges=new THREE.EdgesGeometry(geo);
    const line=new THREE.LineSegments(edges,new THREE.LineBasicMaterial({color:0xffffff,opacity:0.2,transparent:true}));
    line.position.copy(mesh.position);threeScene.add(line);

    // Floor label sprite
    addFloorLabel(f,bW/2+0.3,f*flH+flH/2,bD/2+0.1,floorNames[f]);

    // Windows
    addWindows(f,bW,bD,flH);
  }

  // Roof
  const roofGeo=new THREE.ConeGeometry(3.6,1.5,4);
  const roofMat=new THREE.MeshLambertMaterial({color:0x991b1b});
  const roof=new THREE.Mesh(roofGeo,roofMat);
  roof.position.set(0,4*flH+0.75,0);roof.rotation.y=Math.PI/4;
  roof.castShadow=true;threeScene.add(roof);

  // Trees beside building
  [-3.5,3.5].forEach(tx=>{addTree3D(tx,0,2.5);});

  // Orbit controls (simple manual)
  setupOrbit(c);

  // Animate
  function loop(){
    threeAnimId=requestAnimationFrame(loop);
    threeRenderer.render(threeScene,threeCamera);
  }
  loop();
}

function addWindows(floor,bW,bD,flH){
  const wy=floor*flH+flH/2;
  const windowMat=new THREE.MeshLambertMaterial({color:0x93c5fd,transparent:true,opacity:0.7});
  // front windows
  for(let i=-1;i<=1;i++){
    const wg=new THREE.BoxGeometry(0.6,0.5,0.05);
    const wm=new THREE.Mesh(wg,windowMat);
    wm.position.set(i*1.5,wy,bD/2+0.03);threeScene.add(wm);
  }
}

function addFloorLabel(floor,x,y,z,text){
  // Use a simple colored box as label indicator
  const geo=new THREE.BoxGeometry(0.3,0.15,0.05);
  const mat=new THREE.MeshLambertMaterial({color:floorColors[floor]});
  const m=new THREE.Mesh(geo,mat);m.position.set(x+0.4,y,0);threeScene.add(m);
}

function addTree3D(x,y,z){
  const trunk=new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.12,0.8,8),new THREE.MeshLambertMaterial({color:0x78350f}));
  trunk.position.set(x,0.4,z);threeScene.add(trunk);
  const canopy=new THREE.Mesh(new THREE.SphereGeometry(0.6,10,10),new THREE.MeshLambertMaterial({color:0x4ade80}));
  canopy.position.set(x,1.2,z);threeScene.add(canopy);
}

// Simple orbit
let orbitDragging=false,orbitStart={x:0,y:0},orbitTheta=0.5,orbitPhi=0.9,orbitR=16;
function setupOrbit(c){
  c.addEventListener('mousedown',e=>{orbitDragging=true;orbitStart={x:e.clientX,y:e.clientY};});
  window.addEventListener('mousemove',e=>{
    if(!orbitDragging)return;
    orbitTheta-=(e.clientX-orbitStart.x)*0.01;
    orbitPhi=Math.max(0.2,Math.min(1.4,orbitPhi-(e.clientY-orbitStart.y)*0.01));
    orbitStart={x:e.clientX,y:e.clientY};
    updateCamera();
  });
  window.addEventListener('mouseup',()=>orbitDragging=false);
  c.addEventListener('wheel',e=>{
    e.preventDefault();orbitR=Math.max(8,Math.min(28,orbitR+e.deltaY*0.02));updateCamera();
  },{passive:false});
  // touch
  let ltp=null;
  c.addEventListener('touchstart',e=>{if(e.touches.length===1)ltp={x:e.touches[0].clientX,y:e.touches[0].clientY};});
  c.addEventListener('touchmove',e=>{
    e.preventDefault();
    if(e.touches.length===1&&ltp){
      orbitTheta-=(e.touches[0].clientX-ltp.x)*0.012;
      orbitPhi=Math.max(0.2,Math.min(1.4,orbitPhi-(e.touches[0].clientY-ltp.y)*0.012));
      ltp={x:e.touches[0].clientX,y:e.touches[0].clientY};updateCamera();
    }
  },{passive:false});
}
function updateCamera(){
  if(!threeCamera)return;
  const x=orbitR*Math.sin(orbitPhi)*Math.sin(orbitTheta);
  const y=orbitR*Math.cos(orbitPhi)+2;
  const z=orbitR*Math.sin(orbitPhi)*Math.cos(orbitTheta);
  threeCamera.position.set(x,y,z);threeCamera.lookAt(0,3.5,0);
}
updateCamera();

// Floor selection
function selectFloor(f){
  selectedFloor=f;
  // Update tabs
  document.querySelectorAll('.ftab').forEach(tab=>{
    const tf=parseInt(tab.dataset.floor);
    tab.classList.toggle('active',tf===f);
    tab.style.background=tf===f?floorColorHex[tf]:'';
    tab.style.color=tf===f?'#fff':'';
  });
  // Update details
  document.querySelectorAll('.floor-detail').forEach(d=>d.classList.remove('visible'));
  document.getElementById(`floor-${f}`).classList.add('visible');
  // Highlight 3D floor
  if(floorMeshes.length){
    floorMeshes.forEach((m,i)=>{
      m.material.opacity=i===f?1:0.35;
      m.material.emissive=new THREE.Color(i===f?floorColors[i]:0x000000);
      m.material.emissiveIntensity=i===f?0.2:0;
    });
    // Animate camera to look at selected floor
    const flH=1.8;
    const targetY=f*flH+flH/2+2;
    threeCamera.lookAt(0,targetY,0);
  }
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('resize',()=>{resizeCanvas();});
buildPanel();resizeCanvas();resetView();animate();

// Load Three.js from CDN
const s=document.createElement('script');
s.src='https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js';
s.onload=()=>{/* ready when modal opens */};
document.head.appendChild(s);
</script>
</body>
</html>